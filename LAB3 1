/*
 * Exercise 1: Sleep mode with Timer1 interrupt (bare-metal)
 * MCU: ATmega328P (Arduino Uno)
 * Behavior:
 *   - Timer1 triggers every 1s (CTC mode)
 *   - MCU wakes from sleep, turns LED on for 0.1s, then off
 *   - Returns to sleep
 */

#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>
#include <util/delay.h>
#include <avr/power.h>

#define LED_PIN PB5   // Arduino Uno onboard LED = Digital 13

void timer1_init(void) {
    // --- Configure Timer1 for 1 Hz interrupt using CTC mode ---
    TCCR1A = 0x00;                    // Normal port operation
    TCCR1B = 0x00;                    // Reset control register
    TCCR1B |= (1 << WGM12);           // CTC mode (Clear Timer on Compare Match)

    // Prescaler = 1024 → CS12=1, CS11=0, CS10=1
    TCCR1B |= (1 << CS12) | (1 << CS10);

    // OCR1A = 15624 → 1 second interrupt @ 16 MHz / 1024
    OCR1A = 15624;

    // Enable Compare Match A interrupt
    TIMSK1 |= (1 << OCIE1A);
}

ISR(TIMER1_COMPA_vect) {
    // Interrupt occurs every 1s, wakes MCU from sleep
}

int main(void) {
    // --- Configure LED pin as output ---
    DDRB |= (1 << LED_PIN);   // Set PB5 as output

    // Optional: disable unused peripherals for lower power
    power_adc_disable();
    power_spi_disable();
    power_twi_disable();

    // Initialize Timer1
    timer1_init();

    // Enable global interrupts
    sei();

    // --- Main loop ---
    while (1) {
        // Prepare sleep
        set_sleep_mode(SLEEP_MODE_IDLE);  // Idle keeps Timer1 running
        sleep_enable();

        // Enter sleep — wakes on Timer1 interrupt
        sleep_cpu();

        // MCU resumes here after waking
        sleep_disable();

        // LED task: blink 0.1s
        PORTB |= (1 << LED_PIN);   // LED ON
        _delay_ms(100);
        PORTB &= ~(1 << LED_PIN);  // LED OFF
    }
}
