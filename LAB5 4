//exc4
//formula: Vfan=(d-4)/(20-4) * 255
// 0 = 0 % ; 255 = 100 %

#include <avr/io.h>
#include <util/delay.h>

#define TRIG_PIN 2   // PD2
#define ECHO_PIN 3   // PD3
#define FAN_PIN 6    // PD6 (OC0A)

// ---------- Ultrasonic distance measurement (bare metal) ----------
uint16_t measure_distance_cm() {
    // Trigger the sensor: 10 µs HIGH pulse
    PORTD &= ~(1 << TRIG_PIN);
    _delay_us(2);
    PORTD |= (1 << TRIG_PIN);
    _delay_us(10);
    PORTD &= ~(1 << TRIG_PIN);

    // Wait for echo to go HIGH
    while (!(PIND & (1 << ECHO_PIN)));

    // Measure high pulse width
    uint32_t count = 0;
    while (PIND & (1 << ECHO_PIN)) {
        _delay_us(1);
        count++;
    }

    // Convert to distance (speed of sound)
    // 58 µs per centimeter (approx)
    return count / 58;
}

// ---------- PWM setup (Timer0 Fast PWM on PD6 / OC0A) ----------
void pwm_init() {
    DDRD |= (1 << FAN_PIN);  // PD6 output

    // Fast PWM, non-inverting mode on OC0A
    TCCR0A = (1 << COM0A1) | (1 << WGM01) | (1 << WGM00);

    // Prescaler 64 → ~1kHz PWM
    TCCR0B = (1 << CS01) | (1 << CS00);

    OCR0A = 0;   // start with fan off
}

// ---------- Set fan speed 0–255 ----------
void fan_set_speed(uint8_t speed) {
    OCR0A = speed;
}

// ---------- Setup ----------
void setup() {
    // ultrasonic pins
    DDRD |= (1 << TRIG_PIN);     // trigger output
    DDRD &= ~(1 << ECHO_PIN);    // echo input

    pwm_init();
}

// ---------- Main loop ----------
void loop() {
    uint16_t distance = measure_distance_cm();

    if (distance <= 4) {
        // full speed
        fan_set_speed(255);
    } 
    else if (distance <= 20) {
        // map 4–20 cm → 0–255
        uint8_t speed = (uint8_t)((distance - 4) * (255.0 / 16.0));
        fan_set_speed(speed);
    } 
    else {
        // off
        fan_set_speed(0);
    }

    _delay_ms(2000);   // wait 2 seconds
}
